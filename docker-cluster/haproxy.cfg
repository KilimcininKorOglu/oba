# HAProxy configuration for Oba LDAP cluster

global
    log stdout format raw local0
    maxconn 4096

defaults
    log global
    mode tcp
    option tcplog
    option dontlognull
    timeout connect 5s
    timeout client 30s
    timeout server 30s
    retries 3

# Stats page
frontend stats
    mode http
    bind *:8404
    stats enable
    stats uri /stats
    stats refresh 10s
    stats admin if LOCALHOST

# LDAP frontend - load balance across all nodes
frontend ldap_frontend
    bind *:389
    default_backend ldap_backend

backend ldap_backend
    balance roundrobin
    option tcp-check
    server node1 oba-node1:1389 check inter 5s fall 3 rise 2
    server node2 oba-node2:1389 check inter 5s fall 3 rise 2
    server node3 oba-node3:1389 check inter 5s fall 3 rise 2

# REST API frontend - route writes to leader
frontend rest_frontend
    mode http
    bind *:8080
    default_backend rest_backend

backend rest_backend
    mode http
    balance roundrobin
    option httpchk GET /api/v1/cluster/health
    http-check expect status 200
    # Only route to leader (returns 200), followers return 503
    server node1 oba-node1:8080 check inter 2s fall 2 rise 1
    server node2 oba-node2:8080 check inter 2s fall 2 rise 1
    server node3 oba-node3:8080 check inter 2s fall 2 rise 1

# REST API read-only backend - for read operations
frontend rest_read_frontend
    mode http
    bind *:8081
    default_backend rest_read_backend

backend rest_read_backend
    mode http
    balance roundrobin
    option httpchk GET /api/v1/health
    http-check expect status 200
    server node1 oba-node1:8080 check inter 5s fall 3 rise 2
    server node2 oba-node2:8080 check inter 5s fall 3 rise 2
    server node3 oba-node3:8080 check inter 5s fall 3 rise 2
